<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tes Kraepelin | Tilik Psikologi</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; user-select: none; background-color: #0f172a; color: white; }
        
        .numpad-btn {
            background-color: #1e293b;
            border: 1px solid #334155;
            transition: all 0.1s ease;
        }
        .numpad-btn:active {
            background-color: #334155;
            transform: scale(0.95);
        }
        .number-card {
            background-color: #1e293b;
            border: 1px solid #334155;
        }
        /* Animasi Transisi Angka */
        .number-animation {
            transition: all 0.2s ease-out;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center overflow-hidden">

    <!-- Header (Skor & Timer) -->
    <div id="test-header" class="w-full max-w-md px-6 py-6 flex justify-between items-center opacity-0 transition-opacity duration-500">
        <div class="bg-[#1e293b] px-4 py-2 rounded-lg border border-[#334155] flex items-center gap-2">
            <span class="text-xs font-bold text-slate-400">ðŸ“Š Skor:</span>
            <span id="live-score" class="text-xl font-black text-blue-400">0</span>
        </div>
        <div id="timer" class="text-2xl font-black text-slate-300">15</div>
    </div>

    <!-- Layar Instruksi -->
    <div id="instruction-screen" class="fixed inset-0 z-[100] flex items-center justify-center p-6 bg-[#0f172a]">
        <div class="max-w-sm w-full text-center">
            <div class="w-20 h-20 bg-blue-600 text-white rounded-3xl flex items-center justify-center mx-auto mb-8 text-3xl font-black shadow-xl shadow-blue-900/20">
                +
            </div>
            <h2 class="text-2xl font-bold mb-4">Instruksi Tes</h2>
            <div class="text-slate-400 text-sm space-y-4 mb-10 text-left leading-relaxed">
                <p>1. Jumlahkan dua angka yang muncul secara vertikal.</p>
                <p>2. Ambil <strong>angka terakhir</strong> saja. (Contoh: 8+7=15, tekan 5).</p>
                <p>3. Tekan angka pada numpad atau keyboard untuk menjawab.</p>
            </div>
            <button onclick="startTest()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold text-lg hover:bg-blue-700 transition-all">Mulai Tes</button>
        </div>
    </div>

    <!-- Area Tes (Style Screenshot 181) -->
    <div id="test-screen" class="hidden flex-grow flex flex-col items-center justify-center w-full max-w-md px-6">
        
        <!-- Kartu Angka Utama -->
        <div class="number-card w-full rounded-3xl p-12 mb-8 flex flex-col items-center relative overflow-hidden">
            <div id="num-top" class="text-6xl font-black mb-2 text-white">8</div>
            <div id="num-bottom" class="text-6xl font-black text-white">7</div>
            <div class="text-4xl font-bold text-slate-500 my-2">+</div>
            <div id="num-next" class="text-4xl font-black text-slate-600 opacity-50">1</div>
        </div>

        <!-- Numpad Grid -->
        <div class="grid grid-cols-3 gap-3 w-full mb-8">
            <button onclick="handleInput(1)" class="numpad-btn h-20 rounded-2xl text-3xl font-bold">1</button>
            <button onclick="handleInput(2)" class="numpad-btn h-20 rounded-2xl text-3xl font-bold">2</button>
            <button onclick="handleInput(3)" class="numpad-btn h-20 rounded-2xl text-3xl font-bold">3</button>
            <button onclick="handleInput(4)" class="numpad-btn h-20 rounded-2xl text-3xl font-bold">4</button>
            <button onclick="handleInput(5)" class="numpad-btn h-20 rounded-2xl text-3xl font-bold">5</button>
            <button onclick="handleInput(6)" class="numpad-btn h-20 rounded-2xl text-3xl font-bold">6</button>
            <button onclick="handleInput(7)" class="numpad-btn h-20 rounded-2xl text-3xl font-bold">7</button>
            <button onclick="handleInput(8)" class="numpad-btn h-20 rounded-2xl text-3xl font-bold">8</button>
            <button onclick="handleInput(9)" class="numpad-btn h-20 rounded-2xl text-3xl font-bold">9</button>
            <div class="col-start-2">
                <button onclick="handleInput(0)" class="numpad-btn h-20 w-full rounded-2xl text-3xl font-bold">0</button>
            </div>
        </div>
    </div>

    <!-- Hasil Tes -->
    <div id="result-screen" class="hidden fixed inset-0 z-[200] flex items-center justify-center p-6 bg-[#0f172a]">
        <div class="text-center w-full max-w-sm">
            <h2 class="text-3xl font-bold mb-2">Waktu Habis!</h2>
            <p class="text-slate-400 mb-10">Hasil produktivitas kerja Anda:</p>
            
            <div class="bg-blue-600 py-12 rounded-[3rem] shadow-2xl shadow-blue-900/40 mb-10">
                <p class="text-blue-100 text-xs font-bold uppercase tracking-widest mb-2">Total Benar</p>
                <h3 id="final-score" class="text-8xl font-black text-white">0</h3>
            </div>

            <div class="flex flex-col gap-4">
                <button onclick="location.reload()" class="w-full py-4 bg-slate-800 text-white rounded-2xl font-bold">Ulangi Tes</button>
                <a href="index.html" class="text-slate-500 font-bold text-sm uppercase tracking-widest py-2">Beranda</a>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyBZsXx_T5-5bKp14BLhuZGNfj4Ils71nVA", 
            authDomain: "tilikpsikologi-cbt.firebaseapp.com", 
            projectId: "tilikpsikologi-cbt", 
            storageBucket: "tilikpsikologi-cbt.firebasestorage.app", 
            messagingSenderId: "940142802410", 
            appId: "1:940142802410:web:5e6579568ed2774d9a2e93" 
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let numbers = [];
        let index = 0;
        let score = 0;
        let timeLeft = 15;
        let isFinished = false;
        let timer;

        function generateNumbers() {
            numbers = Array.from({length: 200}, () => Math.floor(Math.random() * 9) + 1);
            updateDisplay();
        }

        function updateDisplay() {
            const numTop = document.getElementById('num-top');
            const numBottom = document.getElementById('num-bottom');
            const numNext = document.getElementById('num-next');

            numTop.innerText = numbers[index];
            numBottom.innerText = numbers[index + 1];
            numNext.innerText = numbers[index + 2] || "?";
        }

        window.handleInput = (val) => {
            if (isFinished) return;

            const correct = (numbers[index] + numbers[index + 1]) % 10;
            if (val === correct) {
                score++;
                document.getElementById('live-score').innerText = score;
            }
            
            index++;
            updateDisplay();
        };

        // Dukungan Keyboard
        window.addEventListener('keydown', (e) => {
            if (!isNaN(e.key)) handleInput(parseInt(e.key));
        });

        window.startTest = () => {
            document.getElementById('instruction-screen').style.display = 'none';
            document.getElementById('test-screen').classList.remove('hidden');
            document.getElementById('test-header').style.opacity = '1';
            
            generateNumbers();

            timer = setInterval(() => {
                timeLeft--;
                document.getElementById('timer').innerText = timeLeft;
                if (timeLeft <= 0) finishTest();
            }, 1000);
        };

        async function finishTest() {
            if (isFinished) return;
            isFinished = true;
            clearInterval(timer);

            const nama = localStorage.getItem("nama_peserta") || "Peserta";
            try {
                await addDoc(collection(db, "hasil_tes"), {
                    nama, tes: "Kraepelin", skor: score, waktu: new Date().toLocaleString('id-ID')
                });
            } catch (err) { console.error(err); }

            document.getElementById('test-screen').classList.add('hidden');
            document.getElementById('test-header').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');
            document.getElementById('final-score').innerText = score;
        }
    </script>
</body>
</html>
