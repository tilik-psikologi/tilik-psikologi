<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tes Kraepelin | Tilik Psikologi</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { 
            font-family: 'Poppins', sans-serif; 
            user-select: none; 
            background-color: #0f172a; 
            color: white; 
            overflow: hidden; /* Mencegah scrolling di mobile */
            touch-action: manipulation; /* Mencegah delay double-tap */
        }
        
        .numpad-btn {
            background-color: #1e293b;
            border: 1px solid #334155;
            transition: all 0.05s ease;
            -webkit-tap-highlight-color: transparent;
            height: 18vw; /* Ukuran dinamis berdasarkan lebar layar */
            max-height: 80px;
        }
        
        .numpad-btn:active {
            background-color: #3b82f6;
            transform: scale(0.92);
        }

        .number-card {
            background-color: #1e293b;
            border: 1px solid #334155;
            height: 35vh; /* Tinggi tetap area angka */
        }

        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Animasi kedip saat salah (opsional, bisa ditambah jika perlu) */
        .flash-wrong { animation: flashRed 0.3s; }
        @keyframes flashRed {
            0%, 100% { background-color: #1e293b; }
            50% { background-color: #7f1d1d; }
        }
    </style>
</head>
<body class="h-screen flex flex-col items-center">

    <!-- Header (Tetap di atas) -->
    <div id="test-header" class="w-full max-w-md px-6 py-4 flex justify-between items-center opacity-0 transition-opacity duration-500">
        <div class="bg-[#1e293b] px-3 py-1.5 rounded-xl border border-[#334155] flex items-center gap-2">
            <span class="text-[10px] font-bold text-slate-400 uppercase">Skor:</span>
            <span id="live-score" class="text-lg font-black text-blue-400">0</span>
        </div>
        <div id="timer" class="text-2xl font-black text-slate-300 tracking-tight">6:00</div>
    </div>

    <!-- Area Tes -->
    <div id="test-screen" class="hidden flex-grow flex flex-col w-full max-w-md px-4">
        
        <!-- Kartu Angka Utama (Display) -->
        <div class="number-card w-full rounded-[2.5rem] flex flex-col items-center justify-center relative mb-4">
            <div id="num-top" class="text-7xl font-black text-white leading-none">0</div>
            <div class="text-3xl font-bold text-slate-500 my-2">+</div>
            <div id="num-bottom" class="text-7xl font-black text-white leading-none">0</div>
            
            <div id="num-next" class="absolute bottom-6 text-xs font-bold text-slate-500 uppercase tracking-widest bg-slate-800/50 px-4 py-1 rounded-full border border-slate-700">
                Berikutnya: 0
            </div>
        </div>

        <!-- Numpad Grid (Input) -->
        <div class="grid grid-cols-3 gap-3 w-full pb-8">
            <button onclick="handleInput(1)" class="numpad-btn rounded-2xl text-3xl font-black text-white shadow-lg">1</button>
            <button onclick="handleInput(2)" class="numpad-btn rounded-2xl text-3xl font-black text-white shadow-lg">2</button>
            <button onclick="handleInput(3)" class="numpad-btn rounded-2xl text-3xl font-black text-white shadow-lg">3</button>
            <button onclick="handleInput(4)" class="numpad-btn rounded-2xl text-3xl font-black text-white shadow-lg">4</button>
            <button onclick="handleInput(5)" class="numpad-btn rounded-2xl text-3xl font-black text-white shadow-lg">5</button>
            <button onclick="handleInput(6)" class="numpad-btn rounded-2xl text-3xl font-black text-white shadow-lg">6</button>
            <button onclick="handleInput(7)" class="numpad-btn rounded-2xl text-3xl font-black text-white shadow-lg">7</button>
            <button onclick="handleInput(8)" class="numpad-btn rounded-2xl text-3xl font-black text-white shadow-lg">8</button>
            <button onclick="handleInput(9)" class="numpad-btn rounded-2xl text-3xl font-black text-white shadow-lg">9</button>
            <div class="col-start-2">
                <button onclick="handleInput(0)" class="numpad-btn w-full rounded-2xl text-3xl font-black text-white shadow-lg">0</button>
            </div>
        </div>
    </div>

    <!-- Layar Instruksi -->
    <div id="instruction-screen" class="fixed inset-0 z-[100] flex items-center justify-center p-6 bg-[#0f172a]">
        <div class="max-w-sm w-full text-center">
            <div class="w-20 h-20 bg-blue-600 text-white rounded-3xl flex items-center justify-center mx-auto mb-8 text-4xl font-black shadow-xl">
                +
            </div>
            <h2 class="text-2xl font-bold mb-4">Instruksi Simulasi Tes Kraepelin</h2>
            <div class="text-slate-400 text-sm space-y-4 mb-10 text-left leading-relaxed">
                <p>1. Jumlahkan dua angka yang muncul vertikal.</p>
                <p>2. Tekan <strong>angka satuan</strong> (angka terakhir) dari hasil jumlah.</p>
                <p>3. Waktu simulasi adalah <strong>6 Menit</strong>.</p>
                <p>4. Fokus pada <strong>kecepatan</strong> dan <strong>ketelitian</strong>.</p>
            </div>
            <button onclick="startTest()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold text-lg hover:bg-blue-700 transition-all">Mulai Simulasi</button>
        </div>
    </div>

    <!-- Hasil Tes -->
    <div id="result-screen" class="hidden fixed inset-0 z-[200] flex items-center justify-center p-6 bg-[#0f172a] overflow-y-auto">
        <div class="text-center w-full max-w-sm py-10">
            <h2 class="text-3xl font-bold mb-2">Tes Selesai</h2>
            <p class="text-slate-400 mb-8 text-sm">Hasil produktivitas simulasi Anda:</p>
            
            <div class="bg-blue-600 py-12 rounded-[3.5rem] shadow-2xl mb-10">
                <p class="text-blue-100 text-[10px] font-bold uppercase tracking-widest mb-2">Total Skor Benar</p>
                <h3 id="final-score" class="text-8xl font-black text-white">0</h3>
            </div>

            <div class="flex flex-col gap-3">
                <button onclick="downloadPDF()" class="w-full py-4 bg-emerald-600 text-white rounded-2xl font-bold text-lg flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                    Unduh PDF
                </button>
                <button onclick="location.reload()" class="w-full py-4 bg-slate-800 text-white rounded-2xl font-bold">Ulangi Tes</button>
                <a href="index.html" class="text-slate-500 font-bold text-sm uppercase py-2">Beranda</a>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyBZsXx_T5-5bKp14BLhuZGNfj4Ils71nVA", authDomain: "tilikpsikologi-cbt.firebaseapp.com", projectId: "tilikpsikologi-cbt", storageBucket: "tilikpsikologi-cbt.firebasestorage.app", messagingSenderId: "940142802410", appId: "1:940142802410:web:5e6579568ed2774d9a2e93" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Data Angka Asli (22 Baris x 50 Kolom)
        const rawData = [
            "5 7 3 9 2 8 4 6 1 5 8 2 7 3 9 4 6 1 5 7 3 8 2 9 4 6 1 5 7 3 9 2 8 4 6 1 5 7 3 8 2 9 4 6 1 5 7 3 9 2",
            "8 4 6 1 5 7 3 9 2 8 4 6 1 5 7 3 9 2 8 4 6 1 5 7 3 9 2 8 4 6 1 5 7 3 9 2 8 4 6 1 5 7 3 9 2 8 4 6 1 5",
            "2 9 4 6 1 5 7 3 8 2 9 4 6 1 5 7 3 8 2 9 4 6 1 5 7 3 8 2 9 4 6 1 5 7 3 8 2 9 4 6 1 5 7 3 8 2 9 4 6 1",
            "7 3 9 2 8 4 6 1 5 7 3 9 2 8 4 6 1 5 7 3 9 2 8 4 6 1 5 7 3 9 2 8 4 6 1 5 7 3 9 2 8 4 6 1 5 7 3 9 2 8",
            "4 6 1 5 7 3 9 2 8 4 6 1 5 7 3 9 2 8 4 6 1 5 7 3 9 2 8 4 6 1 5 7 3 9 2 8 4 6 1 5 7 3 9 2 8 4 6 1 5 7",
            "9 2 8 4 6 1 5 7 3 9 2 8 4 6 1 5 7 3 9 2 8 4 6 1 5 7 3 9 2 8 4 6 1 5 7 3 9 2 8 4 6 1 5 7 3 9 2 8 4 6",
            "3 8 2 9 4 6 1 5 7 3 8 2 9 4 6 1 5 7 3 8 2 9 4 6 1 5 7 3 8 2 9 4 6 1 5 7 3 8 2 9 4 6 1 5 7 3 8 2 9 4",
            "5 7 3 9 2 8 4 6 1 5 7 3 9 2 8 4 6 1 5 7 3 9 2 8 4 6 1 5 7 3 9 2 8 4 6 1 5 7 3 9 2 8 4 6 1 5 7 3 9 2",
            "6 1 5 7 3 8 2 9 4 6 1 5 7 3 8 2 9 4 6 1 5 7 3 8 2 9 4 6 1 5 7 3 8 2 9 4 6 1 5 7 3 8 2 9 4 6 1 5 7 3",
            "8 4 6 1 5 7 3 9 2 8 4 6 1 5 7 3 9 2 8 4 6 1 5 7 3 9 2 8 4 6 1 5 7 3 9 2 8 4 6 1 5 7 3 9 2 8 4 6 1 5",
            "1 5 7 3 9 2 8 4 6 1 5 7 3 9 2 8 4 6 1 5 7 3 9 2 8 4 6 1 5 7 3 9 2 8 4 6 1 5 7 3 9 2 8 4 6 1 5 7 3 9",
            "2 9 4 6 1 5 7 3 8 2 9 4 6 1 5 7 3 8 2 9 4 6 1 5 7 3 8 2 9 4 6 1 5 7 3 8 2 9 4 6 1 5 7 3 8 2 9 4 6 1",
            "7 3 8 2 9 4 6 1 5 7 3 8 2 9 4 6 1 5 7 3 8 2 9 4 6 1 5 7 3 8 2 9 4 6 1 5 7 3 8 2 9 4 6 1 5 7 3 8 2 9",
            "4 6 1 5 7 3 9 2 8 4 6 1 5 7 3 9 2 8 4 6 1 5 7 3 9 2 8 4 6 1 5 7 3 9 2 8 4 6 1 5 7 3 9 2 8 4 6 1 5 7",
            "9 2 8 4 6 1 5 7 3 9 2 8 4 6 1 5 7 3 9 2 8 4 6 1 5 7 3 9 2 8 4 6 1 5 7 3 9 2 8 4 6 1 5 7 3 9 2 8 4 6",
            "5 7 3 9 2 8 4 6 1 5 7 3 9 2 8 4 6 1 5 7 3 9 2 8 4 6 1 5 7 3 9 2 8 4 6 1 5 7 3 9 2 8 4 6 1 5 7 3 9 2",
            "3 9 2 8 4 6 1 5 7 3 9 2 8 4 6 1 5 7 3 9 2 8 4 6 1 5 7 3 9 2 8 4 6 1 5 7 3 9 2 8 4 6 1 5 7 3 9 2 8 4",
            "6 1 5 7 3 8 2 9 4 6 1 5 7 3 8 2 9 4 6 1 5 7 3 8 2 9 4 6 1 5 7 3 8 2 9 4 6 1 5 7 3 8 2 9 4 6 1 5 7 3",
            "8 4 6 1 5 7 3 9 2 8 4 6 1 5 7 3 9 2 8 4 6 1 5 7 3 9 2 8 4 6 1 5 7 3 9 2 8 4 6 1 5 7 3 9 2 8 4 6 1 5",
            "2 9 4 6 1 5 7 3 8 2 9 4 6 1 5 7 3 8 2 9 4 6 1 5 7 3 8 2 9 4 6 1 5 7 3 8 2 9 4 6 1 5 7 3 8 2 9 4 6 1",
            "4 6 1 5 7 3 9 2 8 4 6 1 5 7 3 9 2 8 4 6 1 5 7 3 9 2 8 4 6 1 5 7 3 9 2 8 4 6 1 5 7 3 9 2 8 4 6 1 5 7",
            "7 3 8 2 9 4 6 1 5 7 3 8 2 9 4 6 1 5 7 3 8 2 9 4 6 1 5 7 3 8 2 9 4 6 1 5 7 3 8 2 9 4 6 1 5 7 3 8 2 9"
        ];

        let pairs = [];
        for (let i = 0; i < rawData.length; i += 2) {
            pairs.push({
                top: rawData[i].split(" ").map(Number),
                bottom: rawData[i+1].split(" ").map(Number)
            });
        }

        let pairIdx = 0, colIdx = 0, score = 0, timeLeft = 360, isFinished = false, timer;

        function updateUI() {
            const p = pairs[pairIdx];
            document.getElementById('num-top').innerText = p.top[colIdx];
            document.getElementById('num-bottom').innerText = p.bottom[colIdx];
            
            if (colIdx < 49) {
                document.getElementById('num-next').innerText = `Berikutnya: ${p.top[colIdx+1]} + ${p.bottom[colIdx+1]}`;
            } else {
                document.getElementById('num-next').innerText = "Ganti Baris...";
            }
        }

        window.handleInput = (val) => {
            if (isFinished) return;
            const p = pairs[pairIdx];
            const correct = (p.top[colIdx] + p.bottom[colIdx]) % 10;
            
            if (val === correct) {
                score++;
                document.getElementById('live-score').innerText = score;
            }

            colIdx++;
            if (colIdx >= 50) {
                colIdx = 0;
                pairIdx++;
                if (pairIdx >= pairs.length) return finishTest();
            }
            updateUI();
        };

        window.startTest = () => {
            document.getElementById('instruction-screen').style.display = 'none';
            document.getElementById('test-screen').classList.remove('hidden');
            document.getElementById('test-header').style.opacity = '1';
            updateUI();
            timer = setInterval(() => {
                timeLeft--;
                const m = Math.floor(timeLeft / 60), s = timeLeft % 60;
                document.getElementById('timer').innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
                if (timeLeft <= 0) finishTest();
            }, 1000);
        };

        async function finishTest() {
            if (isFinished) return;
            isFinished = true;
            clearInterval(timer);
            const nama = localStorage.getItem("nama_peserta") || "Peserta";
            try {
                await addDoc(collection(db, "hasil_tes"), { nama, tes: "Kraepelin", skor: score, waktu: new Date().toLocaleString('id-ID') });
            } catch (e) {}
            document.getElementById('test-screen').classList.add('hidden');
            document.getElementById('test-header').style.opacity = '0';
            document.getElementById('result-screen').classList.remove('hidden');
            document.getElementById('final-score').innerText = score;
        }

        window.downloadPDF = () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const nama = localStorage.getItem("nama_peserta") || "Peserta";
            
            doc.setFontSize(22);
            doc.setTextColor(30, 64, 175);
            doc.text("LAPORAN HASIL ASESMEN", 20, 30);
            doc.setFontSize(14);
            doc.setTextColor(0, 0, 0);
            doc.text("Tilik Psikologi", 20, 40);
            doc.line(20, 45, 190, 45);

            doc.setFontSize(11);
            doc.text(`Nama Peserta : ${nama}`, 20, 60);
            doc.text(`Jenis Tes     : Kraepelin (Simulasi 6 Menit)`, 20, 70);
            doc.text(`Total Benar   : ${score} Angka`, 20, 80);

            doc.setDrawColor(220, 0, 0);
            doc.rect(15, 210, 180, 50);
            doc.setFontSize(8);
            const discText = "Simulasi ini hanya untuk tujuan edukasi dan pengenalan diri awal. Pernyataan dan metode skoring ini disederhanakan dan TIDAK SAMA dengan instrumen Kraepelin/Pauli yang valid dan bersertifikasi. Hasilnya tidak dapat dijadikan dasar untuk asesmen psikologis, seleksi karyawan, atau pengambilan keputusan penting. Untuk analisis yang akurat, konsultasikan dengan psikolog atau konsultan SDM bersertifikasi.";
            const splitDisc = doc.splitTextToSize(discText, 170);
            doc.text(splitDisc, 20, 220);

            doc.save(`Hasil_Kraepelin_${nama}.pdf`);
        };

        // Keyboard Support
        window.addEventListener('keydown', (e) => {
            if (!isNaN(e.key)) handleInput(parseInt(e.key));
        });
    </script>
</body>
</html>

