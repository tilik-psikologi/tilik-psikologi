<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tes Kraepelin | TilikPsikologi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Sembunyikan arrow input number */
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .active-column { background-color: #f0f9ff; border: 2px solid #3b82f6; }
        .finished-column { opacity: 0.5; pointer-events: none; }
    </style>
</head>
<body class="bg-slate-900 text-white font-sans overflow-hidden">

    <nav class="bg-slate-800 p-4 flex justify-between items-center border-b border-slate-700">
        <div>
            <h1 class="font-bold text-blue-400">Tes Kraepelin</h1>
            <p id="infoPeserta" class="text-xs text-slate-400 italic">Peserta: -</p>
        </div>
        <div class="flex gap-6 items-center">
            <div class="text-center">
                <p class="text-[10px] uppercase text-slate-400">Kolom</p>
                <p id="colNum" class="font-bold text-xl text-yellow-400">1 / 10</p>
            </div>
            <div class="text-center bg-red-900/30 px-4 py-1 rounded-lg border border-red-500/50">
                <p class="text-[10px] uppercase text-red-400">Sisa Waktu Kolom</p>
                <p id="timer" class="font-mono font-bold text-xl">30</p>
            </div>
        </div>
    </nav>

    <main class="h-[80vh] flex items-center justify-center">
        <div id="game-container" class="flex gap-4 overflow-x-auto p-10 items-end h-full w-full justify-start scroll-smooth">
            </div>
    </main>

    <div id="overlay" class="fixed inset-0 bg-slate-900 flex items-center justify-center z-50 p-6">
        <div class="max-w-md text-center">
            <h2 class="text-3xl font-bold mb-4">Instruksi Kraepelin</h2>
            <p class="text-slate-400 mb-6 text-sm leading-relaxed">
                Jumlahkan dua angka yang berdekatan dari <strong>BAWAH ke ATAS</strong>. 
                Ketik angka terakhir dari hasil penjumlahan (Contoh: 9+7=16, ketik <strong>6</strong>).
                Setiap 30 detik, kolom akan berpindah otomatis.
            </p>
            <button onclick="startTest()" class="bg-blue-600 px-10 py-3 rounded-full font-bold hover:bg-blue-700 transition">
                Mulai Sekarang
            </button>
        </div>
    </div>

    <script>
        const TOTAL_COLUMNS = 10;
        const TIME_PER_COLUMN = 30; // Detik
        let currentColumn = 0;
        let timeLeft = TIME_PER_COLUMN;
        let stats = [];

        // Inisialisasi Data
        window.onload = () => {
            const user = JSON.parse(localStorage.getItem('pesertaAktif'));
            if(user) document.getElementById('infoPeserta').innerText = `Peserta: ${user.nama}`;
            generateGrid();
        };

        function generateGrid() {
            const container = document.getElementById('game-container');
            for (let i = 0; i < TOTAL_COLUMNS; i++) {
                const col = document.createElement('div');
                col.id = `col-${i}`;
                col.className = "flex flex-col-reverse gap-2 p-4 rounded-xl transition-all w-24 shrink-0";
                
                // Generate 50 angka per kolom
                let numbers = [];
                for (let j = 0; j < 50; j++) {
                    const num = Math.floor(Math.random() * 9) + 1;
                    numbers.push(num);
                    const numEl = document.createElement('div');
                    numEl.className = "text-center text-2xl font-bold h-10 flex items-center justify-center";
                    numEl.innerText = num;
                    
                    // Tambahkan input field di antara angka
                    if (j > 0) {
                        const input = document.createElement('input');
                        input.type = "number";
                        input.dataset.col = i;
                        input.dataset.row = j;
                        input.dataset.sum = (numbers[j] + numbers[j-1]) % 10;
                        input.className = "w-full bg-slate-700 border-none rounded text-center text-xl font-bold focus:ring-2 focus:ring-yellow-400 outline-none text-white h-10";
                        input.disabled = true;
                        input.oninput = (e) => handleInput(e.target);
                        col.appendChild(input);
                    }
                    col.appendChild(numEl);
                }
                container.appendChild(col);
            }
        }

        function startTest() {
            document.getElementById('overlay').classList.add('hidden');
            activateColumn(0);
            startTimer();
        }

        function activateColumn(index) {
            currentColumn = index;
            document.getElementById('colNum').innerText = `${index + 1} / ${TOTAL_COLUMNS}`;
            
            // Fokus ke input pertama di kolom aktif
            const inputs = document.querySelectorAll(`input[data-col="${index}"]`);
            inputs.forEach(input => input.disabled = false);
            inputs[0].focus();
            
            // Tambahkan styling aktif
            document.getElementById(`col-${index}`).classList.add('active-column');
            if(index > 0) {
                document.getElementById(`col-${index-1}`).classList.remove('active-column');
                document.getElementById(`col-${index-1}`).classList.add('finished-column');
            }

            // Auto scroll
            document.getElementById(`col-${index}`).scrollIntoView({ behavior: 'smooth', inline: 'center' });
        }

        function handleInput(el) {
            // Jika benar, atau salah tetap lanjut (Kraepelin tidak boleh backspace)
            if(el.value.length > 1) el.value = el.value.slice(-1);
            
            const next = el.nextElementSibling?.nextElementSibling; // Lompat satu angka ke input berikutnya
            if(next && next.tagName === 'INPUT') {
                next.focus();
            }
        }

        function startTimer() {
            const timerEl = document.getElementById('timer');
            const interval = setInterval(() => {
                timeLeft--;
                timerEl.innerText = timeLeft;

                if (timeLeft <= 0) {
                    if (currentColumn < TOTAL_COLUMNS - 1) {
                        hitungSkorKolom(currentColumn);
                        timeLeft = TIME_PER_COLUMN;
                        activateColumn(currentColumn + 1);
                    } else {
                        clearInterval(interval);
                        finishKraepelin();
                    }
                }
            }, 1000);
        }

        function hitungSkorKolom(colIdx) {
            const inputs = document.querySelectorAll(`input[data-col="${colIdx}"]`);
            let benar = 0;
            let total = 0;
            inputs.forEach(input => {
                if(input.value !== "") {
                    total++;
                    if(parseInt(input.value) === parseInt(input.dataset.sum)) benar++;
                }
            });
            stats.push({ kolom: colIdx + 1, benar: benar, total: total });
        }

        function finishKraepelin() {
            localStorage.setItem('hasilKraepelin', JSON.stringify(stats));
            alert("Tes Kraepelin Selesai! Data tersimpan.");
            window.location.href = 'admin.html';
        }
    </script>
</body>
</html>