<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel | Tilik Psikologi</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f1f5f9; color: #1e293b; }
        .admin-card { background: #ffffff; border: 1px solid #e2e8f0; }
        .table-header { background-color: #f8fafc; border-bottom: 2px solid #e2e8f0; }
        .badge-disc { background-color: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }
        .badge-wpt { background-color: #eff6ff; color: #2563eb; border: 1px solid #bfdbfe; }
        .badge-kraepelin { background-color: #ecfdf5; color: #059669; border: 1px solid #a7f3d0; }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="min-h-screen">

    <!-- Main Content -->
    <div id="admin-content" class="p-4 md:p-8 fade-in">
        <div class="max-w-6xl mx-auto">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                <div>
                    <h1 class="text-2xl font-black text-slate-900 tracking-tight">Admin <span class="text-blue-600">Panel</span></h1>
                    <p class="text-slate-500 text-sm">Monitoring hasil asesmen secara real-time.</p>
                </div>
                <div class="flex gap-2 w-full md:w-auto">
                    <input type="text" id="searchInput" onkeyup="filterTable()" placeholder="Cari nama peserta..." class="w-full md:w-64 px-4 py-2 rounded-xl border border-slate-300 outline-none text-sm focus:ring-2 focus:ring-blue-500">
                    <button onclick="exportCSV()" class="bg-blue-600 text-white px-6 py-2 rounded-xl text-sm font-bold shadow-lg hover:bg-blue-700 transition-all">Export CSV</button>
                    <button onclick="location.reload()" class="bg-slate-200 text-slate-600 px-4 py-2 rounded-xl text-sm font-bold hover:bg-slate-300 transition-all">Refresh</button>
                </div>
            </div>

            <!-- Stats Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                <div class="admin-card p-6 rounded-3xl shadow-sm">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Total Data</p>
                    <h3 id="stat-total" class="text-3xl font-black text-slate-900">0</h3>
                </div>
                <div class="admin-card p-6 rounded-3xl shadow-sm border-l-4 border-l-blue-500">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Status Database</p>
                    <h3 id="db-status" class="text-sm font-bold text-amber-500 flex items-center gap-2">
                        <span class="w-2 h-2 bg-amber-500 rounded-full animate-pulse"></span> Menghubungkan...
                    </h3>
                </div>
                <div class="admin-card p-6 rounded-3xl shadow-sm">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Waktu Update</p>
                    <h3 id="stat-time" class="text-sm font-bold text-slate-600">-</h3>
                </div>
            </div>

            <div class="admin-card rounded-[2rem] shadow-xl overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse" id="resultsTable">
                        <thead>
                            <tr class="table-header text-[10px] font-black text-slate-500 uppercase tracking-widest">
                                <th class="px-6 py-5">Waktu Selesai</th>
                                <th class="px-6 py-5">Nama Peserta</th>
                                <th class="px-6 py-5">Jenis Tes</th>
                                <th class="px-6 py-5">Hasil / Skor</th>
                                <th class="px-6 py-5">Catatan</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody" class="text-sm font-medium text-slate-700">
                            <tr>
                                <td colspan="5" class="px-6 py-10 text-center text-slate-400 italic">Mencoba terhubung ke Firebase...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <p class="text-center mt-8 text-[10px] font-bold text-slate-400 uppercase tracking-[0.3em]">Tilik Psikologi Digital System</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Konfigurasi Firebase
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { 
            apiKey: "AIzaSyBZsXx_T5-5bKp14BLhuZGNfj4Ils71nVA", 
            authDomain: "tilikpsikologi-cbt.firebaseapp.com", 
            projectId: "tilikpsikologi-cbt", 
            storageBucket: "tilikpsikologi-cbt.firebasestorage.app", 
            messagingSenderId: "940142802410", 
            appId: "1:940142802410:web:5e6579568ed2774d9a2e93" 
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'tilik-psikologi-prod';

        const setStatus = (text, colorClass) => {
            const el = document.getElementById('db-status');
            el.className = `text-sm font-bold ${colorClass} flex items-center gap-2`;
            el.innerHTML = `<span class="w-2 h-2 ${colorClass.replace('text', 'bg')} rounded-full"></span> ${text}`;
        };

        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    try {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } catch (e) {
                        await signInAnonymously(auth);
                    }
                } else {
                    await signInAnonymously(auth);
                }
            } catch (err) { 
                console.error("Auth error:", err);
                setStatus("Gagal Autentikasi", "text-red-500");
                document.getElementById('tableBody').innerHTML = `<tr><td colspan="5" class="px-6 py-10 text-center text-red-500 font-bold">Error: ${err.message}</td></tr>`;
            }
        };

        initAuth();

        onAuthStateChanged(auth, (user) => { 
            if (user) {
                console.log("User terautentikasi:", user.uid);
                loadData(); 
            }
        });

        function loadData() {
            const resultsCol = collection(db, 'artifacts', appId, 'public', 'data', 'hasil_tes');
            
            // Listener onSnapshot dengan error callback
            onSnapshot(resultsCol, (snapshot) => {
                setStatus("Online", "text-emerald-500");
                const tableBody = document.getElementById('tableBody');
                tableBody.innerHTML = "";
                let dataList = [];
                snapshot.forEach((doc) => dataList.push(doc.data()));
                
                dataList.sort((a, b) => {
                    const parseDate = (str) => {
                        try {
                            const parts = str.split(', ');
                            const dateParts = parts[0].split('/');
                            const timeParts = parts[1].replace(/\./g, ':');
                            return new Date(`${dateParts[2]}-${dateParts[1]}-${dateParts[0]}T${timeParts}`);
                        } catch(e) { return new Date(0); }
                    };
                    return parseDate(b.waktu) - parseDate(a.waktu);
                });

                if(dataList.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="5" class="px-6 py-10 text-center text-slate-400 italic">Database kosong. Belum ada peserta yang menyelesaikan tes.</td></tr>`;
                    document.getElementById('stat-total').innerText = "0";
                    return;
                }

                dataList.forEach((data) => {
                    const tr = document.createElement('tr');
                    tr.className = "border-b border-slate-100 hover:bg-slate-50 transition-colors";
                    let bCls = data.tes === "DISC" ? "badge-disc" : (data.tes === "WPT" ? "badge-wpt" : "badge-kraepelin");
                    tr.innerHTML = `
                        <td class="px-6 py-4 text-[11px] font-mono whitespace-nowrap">${data.waktu}</td>
                        <td class="px-6 py-4 font-bold text-slate-900">${data.nama}</td>
                        <td class="px-6 py-4"><span class="px-3 py-1 rounded-full text-[10px] font-black uppercase ${bCls}">${data.tes}</span></td>
                        <td class="px-6 py-4 font-mono text-xs text-blue-600">${data.skor}</td>
                        <td class="px-6 py-4 text-xs text-slate-500 italic">${data.catatan || '-'}</td>
                    `;
                    tableBody.appendChild(tr);
                });

                document.getElementById('stat-total').innerText = dataList.length;
                document.getElementById('stat-time').innerText = new Date().toLocaleTimeString('id-ID');
            }, (err) => {
                console.error("Firestore error:", err);
                setStatus("Izin Ditolak", "text-red-500");
                document.getElementById('tableBody').innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-10 text-center text-red-500">
                            <p class="font-bold">Gagal memuat data!</p>
                            <p class="text-xs mt-2">Pastikan Firestore Rules Anda mengizinkan akses 'read'.</p>
                            <p class="text-[10px] mt-1 font-mono">${err.message}</p>
                        </td>
                    </tr>`;
            });
        }

        window.filterTable = () => {
            const f = document.getElementById("searchInput").value.toUpperCase();
            const tr = document.getElementById("resultsTable").getElementsByTagName("tr");
            for (let i = 1; i < tr.length; i++) {
                const td = tr[i].getElementsByTagName("td")[1];
                if (td) tr[i].style.display = (td.textContent || td.innerText).toUpperCase().indexOf(f) > -1 ? "" : "none";
            }
        };

        window.exportCSV = () => {
            const table = document.getElementById("resultsTable");
            let csv = [];
            for (let i = 0; i < table.rows.length; i++) {
                let row = [], cols = table.rows[i].cells;
                for (let j = 0; j < cols.length; j++) row.push('"' + cols[j].innerText + '"');
                csv.push(row.join(","));
            }
            const blob = new Blob([csv.join("\n")], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.setAttribute("download", `hasil_tes_tilik_${new Date().toLocaleDateString()}.csv`);
            link.click();
        };
    </script>
</body>
</html>
